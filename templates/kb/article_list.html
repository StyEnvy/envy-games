{% extends "base.html" %}
{% block title %}Knowledge Base — Envy Games{% endblock %}

{% block content %}
<div class="container mx-auto p-4 pt-20 max-w-7xl">

    <!-- Header -->
    <div class="mb-6">
        <div class="breadcrumbs text-sm mb-2">
            <ul>
                <li><a href="{% url 'dashboard:home' %}">Dashboard</a></li>
                <li>Knowledge Base</li>
            </ul>
        </div>
        <h1 class="text-2xl md:text-3xl font-bold">Knowledge Base</h1>
        <p class="opacity-70 text-sm mt-1">Search articles, browse categories, and filter by tags or projects.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar Filters -->
        <aside class="lg:col-span-1">
            <div class="card bg-base-100 shadow">
                <div class="card-body">

                    <!-- Search -->
                    <form method="get" class="mb-4">
                        {% comment %} Preserve existing filters except page {% endcomment %}
                        {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{%
                        endif %}
                        {% if current_tag %}<input type="hidden" name="tag" value="{{ current_tag }}">{% endif %}
                        {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}
                        <label class="form-control w-full">
                            <div class="label"><span class="label-text text-sm">Search</span></div>
                            <div class="join w-full">
                                <input name="q" value="{{ q }}" class="input input-bordered join-item w-full"
                                    placeholder="Title, content, tags…" />
                                <button class="btn btn-primary join-item" type="submit">Go</button>
                            </div>
                        </label>
                    </form>

                    <!-- Drafts Toggle (shows mine only if set) -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">Drafts</span>
                            <div class="join">
                                <a class="btn btn-xs join-item {% if request.GET.drafts %}btn-outline{% else %}btn-active{% endif %}"
                                    href="?{% if querystring %}{{ querystring }}&{% endif %}">{# clear drafts filter
                                    #}All</a>
                                <a class="btn btn-xs join-item {% if request.GET.drafts == 'mine' %}btn-active{% else %}btn-outline{% endif %}"
                                    href="?{% if querystring %}{{ querystring }}&{% endif %}drafts=mine">My Drafts</a>
                            </div>
                        </div>
                        <p class="text-xs opacity-70 mt-1">Only your drafts are visible when enabled.</p>
                    </div>

                    <!-- Categories -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold">Categories</h3>
                            {% if current_category %}
                            <a class="link text-xs" href="?{% if querystring %}{{ querystring }}&{% endif %}">Clear</a>
                            {% endif %}
                        </div>
                        <ul class="menu menu-sm">
                            {% for cat in categories %}
                            <li>
                                <a class="{% if current_category == cat.slug %}active{% endif %}" href="#"
                                    onclick="event.preventDefault();(function(){const qs='{{ querystring|escapejs }}'; const p=new URLSearchParams(qs); p.set('category','{{ cat.slug }}'); p.delete('page'); window.location.search=p.toString();})();">
                                    {{ cat.name }}
                                    <span class="badge badge-ghost badge-sm ml-2">{{ cat.article_count }}</span>
                                </a>
                            </li>
                            {% empty %}
                            <li class="opacity-70">No categories.</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Popular Tags -->
                    <div class="mb-2">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold">Popular Tags</h3>
                            {% if current_tag %}
                            <a class="link text-xs" href="?{% if querystring %}{{ querystring }}&{% endif %}">Clear</a>
                            {% endif %}
                        </div>
                        <div class="flex flex-wrap gap-2">
                            {% for tag,count in popular_tags %}
                            <a class="badge badge-outline cursor-pointer {% if current_tag == tag %}badge-primary{% endif %}"
                                href="#"
                                onclick="event.preventDefault();(function(){const qs='{{ querystring|escapejs }}'; const p=new URLSearchParams(qs); p.set('tag','{{ tag|escapejs }}'); p.delete('page'); window.location.search=p.toString();})();">
                                #{{ tag }} <span class="ml-1 opacity-70">({{ count }})</span>
                            </a>
                            {% empty %}
                            <span class="text-sm opacity-70">No tags yet.</span>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>
        </aside>

        <!-- Articles List -->
        <section class="lg:col-span-3">
            <!-- Sort + Count -->
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm opacity-70">{{ page_obj.paginator.count }} articles found</div>

                <label class="form-control w-auto">
                    <div class="label"><span class="label-text text-xs opacity-70">Sort by</span></div>
                    <select
                        onchange="(function(){const qs='{{ querystring|escapejs }}'; const p=new URLSearchParams(qs); p.set('sort', this.value); p.delete('page'); window.location.search=p.toString();}).call(this)"
                        class="select select-bordered select-sm">
                        <option value="-published_at" {% if sort=='-published_at' %}selected{% endif %}>Newest</option>
                        <option value="published_at" {% if sort=='published_at' %}selected{% endif %}>Oldest</option>
                        <option value="title" {% if sort=='title' %}selected{% endif %}>Title A–Z</option>
                        <option value="-title" {% if sort=='-title' %}selected{% endif %}>Title Z–A</option>
                        <option value="-views_count" {% if sort=='-views_count' %}selected{% endif %}>Most Viewed
                        </option>
                    </select>
                </label>
            </div>

            <!-- Article Cards -->
            <div class="space-y-4">
                {% for article in articles %}
                <div class="card bg-base-100 border">
                    <div class="card-body">
                        <div class="flex items-start justify-between gap-4">
                            <div class="min-w-0">
                                <a href="{{ article.get_absolute_url }}" class="card-title break-words">{{ article.title
                                    }}</a>
                                <div class="mt-1 text-sm opacity-70 flex flex-wrap items-center gap-2">
                                    {% if article.status == 'draft' %}
                                    <span class="badge badge-warning badge-sm">Draft</span>
                                    {% endif %}
                                    {% if article.category %}
                                    <span class="badge badge-ghost badge-sm">{{ article.category.name }}</span>
                                    {% endif %}
                                    {% if article.published_at %}
                                    <span>Published {{ article.published_at|date:"M j, Y" }}</span>
                                    {% endif %}
                                    <span>•</span>
                                    <span>{{ article.views_count|default:0 }} views</span>
                                </div>
                                {% if article.summary %}
                                <p class="mt-3 line-clamp-3">{{ article.summary }}</p>
                                {% endif %}
                                {% if article.tags %}
                                <div class="mt-3 flex flex-wrap gap-2">
                                    <span class="text-xs opacity-70">Tags:</span>
                                    <span class="text-xs">{{ article.tags }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert">
                    <span>No articles match your filters.</span>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.paginator.num_pages > 1 %}
            <div class="join mt-6">
                {% if page_obj.has_previous %}
                <a class="btn btn-sm join-item"
                    href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Prev</a>
                {% else %}
                <button class="btn btn-sm join-item" disabled>Prev</button>
                {% endif %}

                <span class="btn btn-sm join-item btn-ghost no-animation">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <a class="btn btn-sm join-item"
                    href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
                {% else %}
                <button class="btn btn-sm join-item" disabled>Next</button>
                {% endif %}
            </div>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}