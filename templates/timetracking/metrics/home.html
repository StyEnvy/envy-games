{% extends "base.html" %}
{% block title %}Time Metrics — Envy Games{% endblock %}

{% block content %}
<div class="container mx-auto p-4 pt-20 max-w-7xl">

    <!-- Header -->
    <div class="mb-6">
        <div class="breadcrumbs text-sm mb-2">
            <ul>
                <li><a href="{% url 'dashboard:home' %}">Dashboard</a></li>
                <li><a href="{% url 'timetracking:home' %}">Time</a></li>
                <li>Metrics</li>
            </ul>
        </div>

        <div class="flex items-start justify-between gap-3">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold">Time Metrics</h1>
                <p class="opacity-70 text-sm mt-1">Analyze hours by project, task, and time period.</p>

                <!-- Signed-in user & role -->
                <div class="mt-2 flex items-center gap-2">
                    <span class="badge badge-neutral" title="User">{{ user_display_name }}</span>
                    {% if user_role_display %}
                    <span class="badge badge-outline" title="Role">{{ user_role_display }}</span>
                    {% endif %}
                </div>
            </div>

            <a href="{% url 'timetracking:home' %}" class="btn btn-sm btn-outline mt-1"
                aria-label="Record a time entry">Back to Time Entry</a>
        </div>
    </div>

    <!-- Filters -->
    <form id="metrics-filters" class="card bg-base-100 shadow mb-4" aria-label="Metrics filters">
        <div class="card-body grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="label" for="mf-project"><span class="label-text">Project</span></label>
                <select name="project" id="mf-project" class="select select-bordered w-full">
                    <option value="">All projects</option>
                    {% for p in projects %}
                    <option value="{{ p.id }}" {% if p.selected %} selected{% endif %}>{{ p.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="label" for="mf-from"><span class="label-text">From</span></label>
                <input type="date" name="from" id="mf-from" value="{{ from }}" class="input input-bordered w-full" />
            </div>

            <div>
                <label class="label" for="mf-to"><span class="label-text">To</span></label>
                <input type="date" name="to" id="mf-to" value="{{ to }}" class="input input-bordered w-full" />
            </div>

            <div>
                <label class="label" for="mf-bill"><span class="label-text">Billable</span></label>
                <select name="bill" id="mf-bill" class="select select-bordered w-full">
                    <option value="all" {% if bill_all %} selected{% endif %}>All</option>
                    <option value="yes" {% if bill_yes %} selected{% endif %}>Billable only</option>
                    <option value="no" {% if bill_no %} selected{% endif %}>Non-billable only</option>
                </select>
            </div>

            <div>
                <label class="label" for="mf-interval"><span class="label-text">Interval</span></label>
                <select name="interval" id="mf-interval" class="select select-bordered w-full">
                    <option value="day" {% if int_day %} selected{% endif %}>Daily</option>
                    <option value="week" {% if int_week %} selected{% endif %}>Weekly</option>
                    <option value="month" {% if int_month %} selected{% endif %}>Monthly</option>
                </select>
            </div>
        </div>

        <!-- Quick Ranges / Actions -->
        <div class="px-6 pb-4 -mt-4">
            <div class="flex flex-wrap gap-2 items-center">
                <div class="btn-group" role="group" aria-label="Quick ranges">
                    <button type="button" class="btn btn-sm" data-range="this_week">This Week</button>
                    <button type="button" class="btn btn-sm" data-range="last_7">Last 7</button>
                    <button type="button" class="btn btn-sm" data-range="last_30">Last 30</button>
                    <button type="button" class="btn btn-sm" data-range="mtd">MTD</button>
                </div>
                <span class="opacity-50 text-sm">|</span>
                <button type="button" class="btn btn-sm btn-primary" id="mf-apply">Apply</button>
                <button type="button" class="btn btn-sm" id="mf-reset">Reset</button>
                <a class="btn btn-sm btn-outline" id="mf-share" href="#" aria-label="Copy shareable link">
                    Copy Share Link
                </a>
            </div>
        </div>
    </form>

    <!-- Summary KPIs (push URL so share link mirrors state) -->
    <div id="metrics-summary" hx-get="{% url 'timetracking:metrics_summary' %}" hx-include="#metrics-filters"
        hx-trigger="load, change from:#metrics-filters input, change from:#metrics-filters select"
        hx-target="#metrics-summary" hx-swap="outerHTML" hx-sync="this:queue" hx-push-url="true">
        <div class="text-sm opacity-70">Loading summary…</div>
    </div>

    <!-- Trend -->
    <div id="metrics-trend" class="mt-6" hx-get="{% url 'timetracking:metrics_trend' %}" hx-include="#metrics-filters"
        hx-trigger="load, change from:#metrics-filters input, change from:#metrics-filters select"
        hx-target="#metrics-trend" hx-swap="outerHTML" hx-sync="this:queue">
        <div class="text-sm opacity-70">Loading trend…</div>
    </div>

    <!-- Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div id="metrics-table-projects" hx-get="{% url 'timetracking:metrics_table' 'projects' %}"
            hx-include="#metrics-filters"
            hx-trigger="load, change from:#metrics-filters input, change from:#metrics-filters select"
            hx-target="#metrics-table-projects" hx-swap="outerHTML" hx-sync="this:queue">
            <div class="card bg-base-100 shadow">
                <div class="card-body">Loading projects…</div>
            </div>
        </div>

        <div id="metrics-table-tasks" hx-get="{% url 'timetracking:metrics_table' 'tasks' %}"
            hx-include="#metrics-filters"
            hx-trigger="load, change from:#metrics-filters input, change from:#metrics-filters select"
            hx-target="#metrics-table-tasks" hx-swap="outerHTML" hx-sync="this:queue">
            <div class="card bg-base-100 shadow">
                <div class="card-body">Loading tasks…</div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const form = document.getElementById('metrics-filters');
        const elFrom = document.getElementById('mf-from');
        const elTo = document.getElementById('mf-to');
        const elProj = document.getElementById('mf-project');
        const btnApply = document.getElementById('mf-apply');
        const btnReset = document.getElementById('mf-reset');
        const btnsRange = form.querySelectorAll('[data-range]');
        const btnShare = document.getElementById('mf-share');

        function fmt(d) { return d.toISOString().slice(0, 10); }
        function startOfWeek(d) { const x = new Date(d); const wd = (x.getDay() + 6) % 7; x.setDate(x.getDate() - wd); return x; }
        function endOfWeek(d) { const x = startOfWeek(d); x.setDate(x.getDate() + 6); return x; }

        function setRange(kind) {
            const today = new Date(); let a, b;
            if (kind === 'this_week') { a = startOfWeek(today); b = endOfWeek(today); }
            else if (kind === 'last_7') { b = today; a = new Date(b); a.setDate(a.getDate() - 6); }
            else if (kind === 'last_30') { b = today; a = new Date(b); a.setDate(a.getDate() - 29); }
            else if (kind === 'mtd') { a = new Date(today.getFullYear(), today.getMonth(), 1); b = today; }
            elFrom.value = fmt(a); elTo.value = fmt(b);
            htmx.trigger(form, 'change');
        }

        btnsRange.forEach(b => b.addEventListener('click', () => setRange(b.dataset.range)));
        btnApply.addEventListener('click', () => htmx.trigger(form, 'change'));
        btnReset.addEventListener('click', () => {
            const t = new Date(); const a = new Date(t); a.setDate(a.getDate() - 27);
            elFrom.value = fmt(a); elTo.value = fmt(t);
            elProj.value = ''; document.getElementById('mf-bill').value = 'all'; document.getElementById('mf-interval').value = 'week';
            htmx.trigger(form, 'change');
        });

        function currentQuery() {
            const data = new FormData(form);
            const q = new URLSearchParams(data);
            return '?' + q.toString();
        }
        btnShare.addEventListener('click', (e) => {
            e.preventDefault();
            const url = location.pathname + currentQuery();
            navigator.clipboard.writeText(location.origin + url).then(() => {
                btnShare.classList.add('btn-success');
                setTimeout(() => btnShare.classList.remove('btn-success'), 800);
            });
            history.replaceState({}, '', url);
        });

        window.egSetProjectAndRefresh = function (pid) {
            if (!pid) return;
            elProj.value = String(pid);
            htmx.trigger(form, 'change');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
    })();
</script>
{% endblock %}